class DisplayClass{constructor(t,s){this.config=t,this.sendSocketNotification=s.sendSocketNotification,this.sendNotification=s.sendNotification,this.radioStop=s.radioStop,this.timer=null,this.player=null,this.A2D={radio:!1,speak:!1,locked:!1,GA:{transcription:null,done:null},youtube:{displayed:!1,id:null,type:null,title:null},photos:{displayed:!1,position:0,urls:null,length:0},links:{displayed:!1,urls:null,length:0,running:!1},spotify:{connected:!1,librespot:!1,currentVolume:0,targetVolume:this.config.spotify.maxVolume,repeat:null,shuffle:null,forceVolume:!1}},console.log("[A2D] DisplayClass Loaded")}start(t){this.A2D.youtube.displayed&&this.player.command("stopVideo"),this.A2D.photos.displayed&&(this.resetPhotos(),this.hideDisplay()),this.A2D.links.displayed&&(this.resetLinks(),this.hideDisplay());let s={};A2D("Response Scan"),s={GA:{transcription:t.transcription.transcription,done:t.transcription.done},photos:{position:0,urls:t.photos,length:t.photos.length},links:{urls:t.urls,length:t.urls.length}},this.A2D=this.objAssign({},this.A2D,s),this.prepareDisplay(),this.config.photos.usePhotos&&this.A2D.photos.length>0?(this.A2DLock(),this.A2D.photos.displayed=!0,this.photoDisplay(),this.showDisplay()):this.A2D.links.length>0&&this.urlsScan(),A2D("Response Structure:",this.A2D)}photoDisplay(){var t=document.getElementById("A2D_PHOTO");A2D("Loading photo #"+(this.A2D.photos.position+1)+"/"+this.A2D.photos.length),t.src=this.A2D.photos.urls[this.A2D.photos.position],t.addEventListener("load",()=>{A2D("Photo Loaded"),this.timerPhoto=setTimeout(()=>{this.photoNext()},this.config.photos.displayDelay)},{once:!0}),t.addEventListener("error",t=>{this.A2D.photos.displayed&&(A2D("Photo Loading Error... retry with next"),clearTimeout(this.timerPhoto),this.timerPhoto=null,this.photoNext())},{once:!0})}photoNext(){this.A2D.photos.position>=this.A2D.photos.length-1?(this.resetPhotos(),this.hideDisplay()):(this.A2D.photos.position++,this.photoDisplay())}resetPhotos(){clearTimeout(this.timerPhoto),this.timerPhoto=null;this.A2D=this.objAssign({},this.A2D,{photos:{displayed:!1,position:0,urls:null,length:0}}),document.getElementById("A2D_PHOTO").removeAttribute("src"),A2D("Reset Photos",this.A2D)}urlsScan(){if(this.config.useYoutube){var t=new RegExp("youtube.com/([a-z]+)\\?([a-z]+)=([0-9a-zA-Z-_]+)","ig").exec(this.A2D.links.urls[0]);if(t){let s,i={};return this.A2D.radio&&this.radioStop(),this.A2D.spotify.librespot&&this.config.spotify.useSpotify&&(this.config.spotify.useIntegred?this.sendSocketNotification("SPOTIFY_PAUSE"):this.sendNotification("SPOTIFY_PAUSE")),"watch"==t[1]&&(s="id"),"playlist"==t[1]&&(s="playlist"),s?(i={id:t[3],type:s},this.A2D.youtube=this.objAssign({},this.A2D.youtube,i),this.A2DLock(),void this.player.load({id:this.A2D.youtube.id,type:this.A2D.youtube.type})):console.log("[A2D:YouTube] Unknow Type !",t)}}if(this.config.spotify.useSpotify){var s=new RegExp("open.spotify.com/([a-z]+)/([0-9a-zA-Z-_]+)","ig").exec(this.A2D.links.urls[0]);if(s)return this.A2D.radio&&this.radioStop(),!this.A2D.spotify.connected&&this.config.spotify.connectTo&&(this.config.spotify.useIntegred?this.sendSocketNotification("SPOTIFY_TRANSFER",this.config.spotify.connectTo):this.sendNotification("SPOTIFY_TRANSFER",this.config.spotify.connectTo)),void setTimeout(()=>{let t=s[1],i=s[2];"track"==t?this.config.spotify.useIntegred?this.sendSocketNotification("SPOTIFY_PLAY",{uris:["spotify:track:"+i]}):this.sendNotification("SPOTIFY_PLAY",{uris:["spotify:track:"+i]}):this.config.spotify.useIntegred?this.sendSocketNotification("SPOTIFY_PLAY",{context_uri:"spotify:"+t+":"+i}):this.sendNotification("SPOTIFY_PLAY",{context_uri:"spotify:"+t+":"+i})},this.config.spotify.playDelay)}this.config.links.useLinks&&(this.A2DLock(),this.A2D.links.displayed=!0,this.linksDisplay())}linksDisplay(){this.A2D.links.running=!1;var t=document.getElementById("A2D_OUTPUT");A2D("Loading",this.A2D.links.urls[0]),this.showDisplay(),t.src=this.A2D.links.urls[0],t.addEventListener("did-fail-load",()=>{console.log("[A2D:LINKS] Loading error")}),t.addEventListener("crashed",t=>{console.log("[A2D:LINKS] J'ai tout pété mon général !!!"),console.log("[A2D:LINKS]",t)}),t.addEventListener("console-message",t=>{1==t.level&&this.config.debug&&console.log("[A2D:LINKS]",t.message)}),t.addEventListener("did-stop-loading",()=>{this.A2D.links.running||"about:blank"==t.getURL()||(this.A2D.links.running=!0,A2D("URL Loaded",t.getURL()),t.executeJavaScript(`\n      var timer = null\n      function scrollDown(posY){\n        clearTimeout(timer)\n        timer = null\n        var scrollHeight = document.body.scrollHeight\n        if (posY == 0) console.log("Begin Scrolling")\n        if (posY > scrollHeight) posY = scrollHeight\n        document.documentElement.scrollTop = document.body.scrollTop = posY;\n        if (posY == scrollHeight) return console.log("End Scrolling")\n        timer = setTimeout(function(){\n          if (posY < scrollHeight) {\n            posY = posY + ${this.config.links.scrollStep}\n            scrollDown(posY);\n          }\n        }, ${this.config.links.scrollInterval});\n      };\n      if (${this.config.links.scrollActivate}) {\n        setTimeout(scrollDown(0), ${this.config.links.scrollStart});\n      };`))}),this.timerLinks=setTimeout(()=>{this.resetLinks(),this.hideDisplay()},this.config.links.displayDelay)}resetLinks(){clearTimeout(this.timerLinks),this.timerLinks=null;this.A2D=this.objAssign({},this.A2D,{links:{displayed:!1,urls:null,length:0,running:!1}}),document.getElementById("A2D_OUTPUT").src="about:blank",A2D("Reset Links",this.A2D)}showYT(){var t=document.getElementById("A2D_YOUTUBE"),s=document.getElementById("A2D");this.A2D.youtube.displayed?(this.A2DLock(),s.classList.remove("hidden"),t.classList.remove("hidden")):this.A2D.photos.displayed||this.A2D.links.displayed?(s.classList.remove("hidden"),t.classList.add("hidden")):this.hideDisplay()}titleYT(){document.getElementById("A2D_TRANSCRIPTION").getElementsByTagName("p")[0].innerHTML=this.A2D.youtube.title}resetYT(){this.A2D=this.objAssign({},this.A2D,{youtube:{displayed:!1,id:null,type:null,title:null}}),A2D("Reset YouTube",this.A2D)}castStart(t){this.A2D.youtube.displayed&&this.player.command("stopVideo"),this.A2D.spotify.connected&&this.A2D.spotify.librespot&&(this.config.spotify.useIntegred?this.sendSocketNotification("SPOTIFY_PAUSE"):this.sendNotification("SPOTIFY_PAUSE")),this.A2D.photos.displayed&&(this.resetPhotos(),this.hideDisplay()),this.A2D.links.displayed&&(this.resetLinks(),this.hideDisplay()),this.A2D.radio&&this.radioStop(),this.A2D.GA.transcription="YouTube Cast",this.prepareDisplay(),this.A2D.links.running=!1;var s=document.getElementById("A2D_OUTPUT");A2D("Cast Loading",t),this.A2D.links.displayed=!0,this.A2D.links.running=!0,this.showDisplay(),this.A2DLock(),s.src=t}castStop(){document.getElementById("A2D_OUTPUT");this.resetLinks(),this.hideDisplay()}prepare(){}prepareDisplay(){}showDisplay(){A2D("Show Iframe");var t=document.getElementById("A2D_YOUTUBE"),s=document.getElementById("A2D_OUTPUT"),i=document.getElementById("A2D_PHOTO"),e=document.getElementById("A2D");this.A2D.speak?e.classList.add("hidden"):e.classList.remove("hidden"),this.A2D.links.displayed&&s.classList.remove("hidden"),this.A2D.photos.displayed&&i.classList.remove("hidden"),this.A2D.photos.forceClose&&i.classList.add("hidden"),this.A2D.youtube.displayed&&t.classList.remove("hidden")}hideDisplay(){A2D("Hide Iframe");var t=document.getElementById("A2D"),s=document.getElementById("A2D_OUTPUT"),i=document.getElementById("A2D_PHOTO"),e=document.getElementById("A2D_YOUTUBE");this.A2D.youtube.displayed||e.classList.add("hidden"),this.A2D.links.displayed||s.classList.add("hidden"),this.A2D.photos.displayed||i.classList.add("hidden"),!this.A2D.speak&&this.working()||t.classList.add("hidden"),this.A2D.speak||this.working()||this.A2DUnlock()}hideSpotify(){var t=document.getElementById("module_A2D_Spotify"),s=document.getElementById("A2D_SPOTIFY");this.timer=null,clearTimeout(this.timer),s.classList.remove("bottomIn"),s.classList.add("bottomOut"),this.timer=setTimeout(()=>{s.classList.add("inactive"),t.style.display="none"},500)}showSpotify(){var t=document.getElementById("module_A2D_Spotify"),s=document.getElementById("A2D_SPOTIFY");t.style.display="block",s.classList.remove("bottomOut"),s.classList.add("bottomIn"),s.classList.remove("inactive")}A2DLock(){this.A2D.locked||(A2D("Lock Screen"),MM.getModules().exceptWithClass("MMM-GoogleAssistant").enumerate(t=>{t.hide(15,{lockString:"A2D_LOCKED"})}),this.A2D.spotify.connected&&this.config.spotify.useIntegred&&this.hideSpotify(),this.config.screen.useScreen&&this.sendSocketNotification("SCREEN_LOCK",!0),this.A2D.locked=!0)}A2DUnlock(){this.A2D.locked&&!this.working()&&(A2D("Unlock Screen"),MM.getModules().exceptWithClass("MMM-GoogleAssistant").enumerate(t=>{t.show(15,{lockString:"A2D_LOCKED"})}),this.A2D.spotify.connected&&this.config.spotify.useIntegred&&this.showSpotify(),this.config.screen.useScreen&&!this.A2D.spotify.connected&&this.sendSocketNotification("SCREEN_LOCK",!1),this.A2D.locked=!1)}objAssign(t){for(var s,i,e=Array.prototype.slice.call(arguments,1);e.length;)for(i in s=e.shift())s.hasOwnProperty(i)&&("object"==typeof t[i]&&t[i]&&"[object Array]"!==Object.prototype.toString.call(t[i])&&"object"==typeof s[i]&&null!==s[i]?t[i]=this.objAssign({},t[i],s[i]):t[i]=s[i]);return t}working(){return this.A2D.youtube.displayed||this.A2D.photos.displayed||this.A2D.links.displayed}}
